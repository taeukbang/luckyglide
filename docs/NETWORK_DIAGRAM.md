# 네트워크 구성도

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         사용자 브라우저                                  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  https://luckyglide.vercel.app/partner1                           │  │
│  │  (파트너 경로에서 예약하기 버튼 클릭)                               │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           │                                               │
│                           │ HTTPS 요청                                    │
│                           ▼                                               │
└─────────────────────────────────────────────────────────────────────────┘
                           │
                           │
        ┌──────────────────┴──────────────────┐
        │                                      │
        ▼                                      ▼
┌──────────────────────┐          ┌──────────────────────┐
│  Vercel (프로덕션)    │          │  Vercel (프로덕션)    │
│                      │          │                      │
│  ┌────────────────┐  │          │  ┌────────────────┐  │
│  │ 프론트엔드 앱   │  │          │  │ API 라우트      │  │
│  │ (React)        │  │          │  │ Edge Runtime   │  │
│  │                │  │          │  │                │  │
│  │ - Index.tsx   │  │          │  │ - mylink-query │  │
│  │ - FlightCard   │  │          │  │   .ts          │  │
│  │ - 예약하기 버튼 │  │          │  │                │  │
│  └────────────────┘  │          │  └────────────────┘  │
│         │            │          │         │            │
│         │            │          │         │            │
│         └────────────┼──────────┴─────────┘            │
│                      │                                 │
│                      │ API 호출                        │
│                      │ GET /api/mrt/partner/mylink-query│
│                      │                                 │
└──────────────────────┼─────────────────────────────────┘
                       │
                       │ HTTPS (Supabase 연결)
                       ▼
        ┌──────────────────────────────────────┐
        │  Supabase (데이터베이스)              │
        │                                      │
        │  ┌────────────────────────────────┐  │
        │  │ partner_mylinks 테이블         │  │
        │  │                                │  │
        │  │ - partner_id                   │  │
        │  │ - from, to                     │  │
        │  │ - departure_date, return_date  │  │
        │  │ - mylink (저장된 마이링크)      │  │
        │  └────────────────────────────────┘  │
        │                                      │
        │  ✅ Vercel은 Supabase와 정상 연결    │
        │  ✅ 마이링크 조회 가능                │
        └──────────────────────────────────────┘
                       │
                       │ (데이터 반환)
                       ▼
        ┌──────────────────────────────────────┐
        │  사용자 브라우저                      │
        │  마이링크로 리다이렉트                  │
        │  (예: https://myrealt.rip/abc123)    │
        └──────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                    로컬 개발 환경 (사용자 컴퓨터)                         │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │  scripts/generate-mylinks.ts                                     │  │
│  │  (마이링크 생성 스크립트)                                         │  │
│  │                                                                  │  │
│  │  1. 예약 URL 생성                                                │  │
│  │  2. 마이링크 생성 API 호출                                        │  │
│  │  3. Supabase에 저장                                              │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                           │                                              │
│                           │ HTTP POST 요청 시도                          │
│                           │ (포트 443, HTTPS)                            │
│                           ▼                                              │
└─────────────────────────────────────────────────────────────────────────┘
                           │
                           │
        ┌──────────────────┴──────────────────┐
        │                                      │
        │  ❌ 연결 차단/타임아웃                │
        │  (회사 방화벽 또는 네트워크 정책)      │
        │                                      │
        ▼                                      ▼
┌──────────────────┐              ┌──────────────────┐
│  회사 방화벽      │              │  회사 네트워크    │
│  (Firewall)      │              │  게이트웨이       │
│                  │              │                  │
│  외부 API 접근    │              │  외부 접근 제한   │
│  차단 가능        │              │  정책 적용       │
└──────────────────┘              └──────────────────┘
        │                                      │
        └──────────────────┬──────────────────┘
                           │
                           │ ❌ 연결 실패
                           │ (타임아웃)
                           ▼
        ┌──────────────────────────────────────┐
        │  인터넷 (Internet)                    │
        │                                      │
        │  ⚠️  여기까지 도달하지 못함           │
        └──────────────────────────────────────┘
                           │
                           │ (만약 연결된다면)
                           ▼
        ┌──────────────────────────────────────┐
        │  마이리얼트립 API 서버                  │
        │  partner-ext-api.myrealtrip.com       │
        │  IP: 43.202.207.91, 3.39.123.80      │
        │  포트: 443 (HTTPS)                    │
        │                                      │
        │  ✅ API 키 권한은 승인됨              │
        │  ❌ 하지만 네트워크 연결이 안됨       │
        └──────────────────────────────────────┘
                           │
                           │ (마이링크 생성)
                           │ (예: https://myrealt.rip/abc123)
                           ▼
        ┌──────────────────────────────────────┐
        │  Supabase (데이터베이스)              │
        │  partner_mylinks 테이블에 저장        │
        │                                      │
        │  ✅ 로컬 스크립트는 Supabase와 연결됨 │
        └──────────────────────────────────────┘
```

## 핵심 포인트

### 1. Vercel의 역할
- ✅ **프론트엔드 호스팅**: React 앱을 사용자에게 제공
- ✅ **API 라우트 호스팅**: `/api/mrt/partner/mylink-query` 엔드포인트 제공
- ✅ **Supabase 연결**: Edge Runtime에서 Supabase와 직접 연결 (정상 작동)
- ❌ **마이리얼트립 API 직접 호출 안함**: Vercel에서는 마이링크 생성 API를 호출하지 않음

### 2. 로컬 스크립트의 역할
- ✅ **마이링크 생성**: 마이리얼트립 API를 호출하여 마이링크 생성
- ✅ **Supabase 저장**: 생성된 마이링크를 Supabase에 저장
- ❌ **현재 네트워크 문제**: 회사 방화벽으로 인해 마이리얼트립 API 접근 불가

### 3. 데이터 흐름

**정상 작동 시:**
```
[로컬 스크립트]
    ↓ (마이링크 생성)
[마이리얼트립 API] ✅ (연결 성공 시)
    ↓ (마이링크 반환)
[Supabase 저장] ✅
    ↓
[Vercel API] (mylink-query)
    ↓ (조회)
[Supabase] ✅
    ↓ (마이링크 반환)
[사용자 브라우저] ✅
    ↓ (리다이렉트)
[마이리얼트립 예약 페이지]
```

**현재 상황:**
```
[로컬 스크립트]
    ↓ (마이링크 생성 시도)
[회사 방화벽] ❌ (차단)
    ↓ (도달 못함)
[마이리얼트립 API] ❌
```

## 현재 상황 (연결 실패)

```
┌─────────────────────────────────────────────────────────────────┐
│                    사용자 컴퓨터 (로컬)                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  scripts/generate-mylinks.ts                              │  │
│  │  (마이링크 생성 스크립트)                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           │                                      │
│                           │ HTTP POST 요청 시도                  │
│                           │ (포트 443, HTTPS)                    │
│                           ▼                                      │
└─────────────────────────────────────────────────────────────────┘
                           │
                           │
        ┌──────────────────┴──────────────────┐
        │                                      │
        │  ❌ 연결 차단/타임아웃                │
        │  (방화벽 또는 네트워크 정책)          │
        │                                      │
        ▼                                      ▼
┌──────────────────┐              ┌──────────────────┐
│  회사 방화벽      │              │  회사 네트워크    │
│  (Firewall)      │              │  게이트웨이       │
│                  │              │                  │
│  외부 API 접근    │              │  외부 접근 제한   │
│  차단 가능        │              │  정책 적용       │
└──────────────────┘              └──────────────────┘
        │                                      │
        └──────────────────┬──────────────────┘
                           │
                           │ ❌ 연결 실패
                           │ (타임아웃)
                           ▼
        ┌──────────────────────────────────────┐
        │  인터넷 (Internet)                    │
        │                                      │
        │  ⚠️  여기까지 도달하지 못함           │
        └──────────────────────────────────────┘
                           │
                           │ (만약 연결된다면)
                           ▼
        ┌──────────────────────────────────────┐
        │  마이리얼트립 API 서버                  │
        │  partner-ext-api.myrealtrip.com       │
        │  IP: 43.202.207.91, 3.39.123.80      │
        │  포트: 443 (HTTPS)                    │
        │                                      │
        │  ✅ API 키 권한은 승인됨              │
        │  ❌ 하지만 네트워크 연결이 안됨       │
        └──────────────────────────────────────┘
```

## 문제점 분석

### 1. 연결 경로
```
[로컬 스크립트] 
    ↓ (HTTPS 요청)
[회사 방화벽/게이트웨이] ← ❌ 여기서 차단됨
    ↓ (차단되어 도달 못함)
[인터넷]
    ↓ (도달 못함)
[마이리얼트립 API 서버]
```

### 2. 현재 상태
- ✅ **API 키**: 권한 승인 완료
- ✅ **DNS 해석**: 정상 (IP 주소 확인됨)
- ❌ **네트워크 연결**: 실패 (타임아웃)
- ❌ **포트 접근**: 443 포트 차단 가능성

### 3. 가능한 원인
1. **회사 방화벽 정책**
   - 외부 API 서버 접근 차단
   - 특정 도메인/포트 차단

2. **네트워크 게이트웨이 제한**
   - 아웃바운드 트래픽 필터링
   - 프록시 서버 필요할 수 있음

3. **회사 보안 정책**
   - 외부 API 호출 제한
   - 화이트리스트 기반 접근 제어

## 해결 방법

### 방법 1: IT 담당자에게 문의
```
회사 IT 담당자에게 요청:
- partner-ext-api.myrealtrip.com (포트 443) 접근 허용
- 또는 API 호출용 프록시 서버 정보 제공
```

### 방법 2: 다른 네트워크에서 테스트
```
[집 네트워크/모바일 핫스팟]
    ↓ (HTTPS 요청)
[인터넷]
    ↓ (정상 연결)
[마이리얼트립 API 서버] ✅
```

### 방법 3: 프록시 설정 (필요시)
```
[로컬 스크립트]
    ↓
[회사 프록시 서버] ← 프록시 설정 필요
    ↓
[인터넷]
    ↓
[마이리얼트립 API 서버]
```

## 정상 작동 시 예상 흐름

```
[로컬 스크립트 실행]
    ↓
[예약 URL 생성] (예: flights.myrealtrip.com/...)
    ↓
[마이링크 생성 API 호출]
    POST https://partner-ext-api.myrealtrip.com/v1/mylink
    Headers: Authorization: Bearer [API_KEY]
    ↓
[마이리얼트립 API 서버]
    ↓
[마이링크 생성] (예: https://myrealt.rip/abc123)
    ↓
[Supabase에 저장]
    partner_mylinks 테이블에 저장
    ↓
[완료] ✅
```

## 현재 상황 요약

```
┌─────────────┐
│ 로컬 스크립트│
└──────┬──────┘
       │
       │ ❌ 여기서 막힘
       ▼
┌─────────────┐
│ 회사 방화벽 │ ← 차단됨
└─────────────┘
       │
       │ (도달 못함)
       ▼
┌─────────────┐
│ API 서버    │ ← 연결 실패
└─────────────┘
```

**결론**: API 키는 정상이지만, 회사 네트워크에서 외부 API 서버로의 연결이 차단되고 있습니다.

---

## 간단한 요약 다이어그램

### 전체 시스템 구성

```
┌──────────────┐
│ 사용자       │
│ (브라우저)   │
└──────┬───────┘
       │
       │ 접속
       ▼
┌─────────────────────────────────────┐
│  Vercel (프로덕션)                   │
│  https://luckyglide.vercel.app      │
│                                     │
│  ┌──────────────┐  ┌─────────────┐ │
│  │ 프론트엔드   │  │ API 라우트   │ │
│  │ (React 앱)  │→ │ (Edge)      │ │
│  └──────────────┘  └──────┬──────┘ │
│                           │        │
└───────────────────────────┼────────┘
                            │
                            │ 조회
                            ▼
                  ┌─────────────────┐
                  │ Supabase        │
                  │ (데이터베이스)   │
                  │                 │
                  │ partner_mylinks │
                  │ 테이블          │
                  └─────────────────┘
                            ▲
                            │ 저장
                            │
                  ┌─────────┴─────────┐
                  │                   │
        ┌─────────┴─────────┐  ┌─────┴──────┐
        │ 로컬 스크립트      │  │ (정상 연결)│
        │ generate-mylinks.ts│  │            │
        └─────────┬─────────┘  └────────────┘
                  │
                  │ 마이링크 생성 API 호출
                  │ ❌ 회사 방화벽 차단
                  ▼
        ┌─────────────────────┐
        │ 마이리얼트립 API 서버 │
        │ (연결 실패)          │
        └─────────────────────┘
```

### Vercel이 하는 일 vs 안 하는 일

**Vercel이 하는 일:**
- ✅ 프론트엔드 앱 호스팅 및 제공
- ✅ API 라우트 제공 (`/api/mrt/partner/mylink-query`)
- ✅ Supabase에서 데이터 조회
- ✅ 사용자 요청 처리

**Vercel이 안 하는 일:**
- ❌ 마이리얼트립 API 직접 호출 (로컬 스크립트에서만 수행)
- ❌ 마이링크 생성 (로컬 스크립트에서만 수행)

### 왜 하이브리드 방식인가?

```
문제: Vercel에서 마이리얼트립 API 직접 호출 시
     - IP 화이트리스트 문제
     - Vercel의 동적 IP로 인한 제한

해결: 하이브리드 방식
     1. 로컬 스크립트로 마이링크 미리 생성 → Supabase 저장
     2. Vercel은 Supabase에서만 조회 (IP 제한 없음)
     3. 사용자는 Vercel을 통해 마이링크 받음
```

### 현재 문제점

```
[로컬 스크립트] 
    ↓
[회사 방화벽] ← ❌ 여기서 막힘
    ↓
[마이리얼트립 API] ← 도달 못함

→ 결과: 마이링크를 생성할 수 없어서 Supabase에 저장 불가
→ 영향: Vercel에서 조회할 마이링크가 없음
```

