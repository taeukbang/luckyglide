# ë§ˆì´ë§í¬ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## 1ë‹¨ê³„: Supabase ìŠ¤í‚¤ë§ˆ ìƒì„±

Supabase ëŒ€ì‹œë³´ë“œì—ì„œ SQL Editorë¥¼ ì—´ê³  `server/schema.sql`ì˜ ë‹¤ìŒ ë¶€ë¶„ì„ ì‹¤í–‰:

```sql
-- Partner MyLinks í…Œì´ë¸” ìƒì„±
create table if not exists public.partner_mylinks (
  id bigint generated by default as identity primary key,
  partner_id text not null,
  "from" text not null,
  "to" text not null,
  departure_date date not null,
  return_date date not null,
  trip_days int,
  nonstop boolean default false,
  booking_url text not null,
  mylink text not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint partner_mylinks_unique unique(partner_id, "from", "to", departure_date, return_date, trip_days, nonstop)
);

-- ì¸ë±ìŠ¤ ìƒì„±
create index if not exists idx_partner_mylinks_lookup on public.partner_mylinks (partner_id, "from", "to", departure_date, return_date, trip_days, nonstop);
create index if not exists idx_partner_mylinks_partner on public.partner_mylinks (partner_id);
```

**í™•ì¸ ë°©ë²•:**
```sql
-- í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
SELECT * FROM public.partner_mylinks LIMIT 1;
```

## 2ë‹¨ê³„: í™˜ê²½ë³€ìˆ˜ ì„¤ì •

`.env` íŒŒì¼ ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ì— ë‹¤ìŒì„ ì„¤ì •:

```bash
# Supabase ì„¤ì • (í•„ìˆ˜)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key

# íŒŒíŠ¸ë„ˆ API í‚¤ (í…ŒìŠ¤íŠ¸ìš© íŒŒíŠ¸ë„ˆ)
PARTNER_ID=test-partner
MRT_PARTNER_API_KEY_test-partner=your-api-key-here
```

**í™•ì¸ ë°©ë²•:**
```bash
# í™˜ê²½ë³€ìˆ˜ í™•ì¸
echo $SUPABASE_URL
echo $MRT_PARTNER_API_KEY_test-partner
```

## 3ë‹¨ê³„: ë¡œì»¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë§ˆì´ë§í¬ ìƒì„± í…ŒìŠ¤íŠ¸

### 3-1. ì†Œê·œëª¨ í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ í™•ì¸)

íŠ¹ì • ëª©ì ì§€ë§Œ í…ŒìŠ¤íŠ¸:

```bash
PARTNER_ID=test-partner \
MRT_PARTNER_API_KEY_test-partner=YOUR_API_KEY \
GEN_FROM=ICN \
GEN_CODES=TYO \
GEN_DAYS=3 \
GEN_MIN_DAYS=3 \
GEN_MAX_DAYS=3 \
GEN_NONSTOP=false \
npm run generate-mylinks
```

**ì˜ˆìƒ ì¶œë ¥:**
```
[generate-mylinks] partner=test-partner from=ICN targets=1 days=3 tripDays=3-3 nonstop=false
[ok] test-partner ICN->TYO 2024-11-10~2024-11-13 (3ì¼) - https://myrealt.rip/abc123...
[ok] test-partner ICN->TYO 2024-11-11~2024-11-14 (3ì¼) - https://myrealt.rip/def456...
[done] partner=test-partner success=3 fail=0 skipped=0
```

### 3-2. Supabaseì—ì„œ ë°ì´í„° í™•ì¸

Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸:

```sql
-- ìƒì„±ëœ ë§ˆì´ë§í¬ í™•ì¸
SELECT 
  partner_id,
  "from",
  "to",
  departure_date,
  return_date,
  trip_days,
  mylink,
  created_at
FROM public.partner_mylinks
WHERE partner_id = 'test-partner'
ORDER BY created_at DESC
LIMIT 10;
```

## 4ë‹¨ê³„: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸

### 4-1. ë§ˆì´ë§í¬ ì¡°íšŒ API í…ŒìŠ¤íŠ¸

ë¸Œë¼ìš°ì € ë˜ëŠ” curlë¡œ í…ŒìŠ¤íŠ¸:

```bash
# ë¡œì»¬ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘ì¼ ë•Œ
curl "http://localhost:5173/api/mrt/partner/mylink-query?partnerId=test-partner&from=ICN&to=TYO&depdt=2024-11-10&rtndt=2024-11-13&tripDays=3&nonstop=false"
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "mylink": "https://myrealt.rip/abc123def456"
}
```

ë˜ëŠ” ë§ˆì´ë§í¬ê°€ ì—†ëŠ” ê²½ìš°:
```json
{
  "mylink": null
}
```

### 4-2. ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸

ê°œë°œ ì„œë²„ ì‹¤í–‰:
```bash
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†:
```
http://localhost:5173/api/mrt/partner/mylink-query?partnerId=test-partner&from=ICN&to=TYO&depdt=2024-11-10&rtndt=2024-11-13&tripDays=3&nonstop=false
```

## 5ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ í†µí•© í…ŒìŠ¤íŠ¸

### 5-1. íŒŒíŠ¸ë„ˆ ê²½ë¡œ ì ‘ì†

ê°œë°œ ì„œë²„ ì‹¤í–‰:
```bash
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ íŒŒíŠ¸ë„ˆ ê²½ë¡œ ì ‘ì†:
```
http://localhost:5173/test-partner
```

### 5-2. ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­ í…ŒìŠ¤íŠ¸

1. íŒŒíŠ¸ë„ˆ ê²½ë¡œ(`/test-partner`)ì—ì„œ í•­ê³µê¶Œ ê²€ìƒ‰
2. ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­
3. ê°œë°œì ë„êµ¬ ì½˜ì†” í™•ì¸:
   - Network íƒ­ì—ì„œ `/api/mrt/partner/mylink-query` ìš”ì²­ í™•ì¸
   - ë§ˆì´ë§í¬ê°€ ë°˜í™˜ë˜ëŠ”ì§€ í™•ì¸
4. ì‹¤ì œ ë§í¬ í™•ì¸:
   - í´ë¦­í•œ ë§í¬ê°€ `https://myrealt.rip/...` í˜•ì‹ì¸ì§€ í™•ì¸

### 5-3. Fallback í…ŒìŠ¤íŠ¸

ë§ˆì´ë§í¬ê°€ ì—†ëŠ” ì¡°í•©ìœ¼ë¡œ í…ŒìŠ¤íŠ¸:

1. Supabaseì—ì„œ íŠ¹ì • ì¡°í•© ì‚­ì œ:
```sql
DELETE FROM public.partner_mylinks 
WHERE partner_id = 'test-partner' 
  AND "from" = 'ICN' 
  AND "to" = 'BKK' 
  AND departure_date = '2024-11-15';
```

2. í•´ë‹¹ ì¡°í•©ìœ¼ë¡œ ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­
3. ê¸°ì¡´ ì˜ˆì•½ URLë¡œ fallbackë˜ëŠ”ì§€ í™•ì¸ (ë§ˆì´ë§í¬ê°€ ì•„ë‹Œ ì¼ë°˜ URL)

## 6ë‹¨ê³„: ì¼ë°˜ ê²½ë¡œ í…ŒìŠ¤íŠ¸ (ê¸°ì¡´ ê¸°ëŠ¥ í™•ì¸)

ì¼ë°˜ ê²½ë¡œ(`/`)ì—ì„œë„ ê¸°ì¡´ ê¸°ëŠ¥ì´ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸:

```
http://localhost:5173/
```

- ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ì´ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
- ë§ˆì´ë§í¬ ë³€í™˜ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸

## ë¬¸ì œ í•´ê²°

### ë§ˆì´ë§í¬ ìƒì„± ì‹¤íŒ¨

**ì¦ìƒ:** `[fail] ... - ë§ˆì´ë§í¬ ìƒì„± ì‹¤íŒ¨`

**í™•ì¸ ì‚¬í•­:**
1. API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
2. API í‚¤ì— IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
3. `targetUrl`ì´ ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½ ë„ë©”ì¸ì¸ì§€ í™•ì¸

**ë””ë²„ê¹…:**
```bash
# API í‚¤ í™•ì¸
echo $MRT_PARTNER_API_KEY_test-partner

# ì§ì ‘ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸
curl -X POST \
  "https://partner-ext-api.myrealtrip.com/v1/mylink?targetUrl=https://www.myrealtrip.com/offers/123" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### Supabase ì¡°íšŒ ì‹¤íŒ¨

**ì¦ìƒ:** APIì—ì„œ `mylink: null` ë°˜í™˜

**í™•ì¸ ì‚¬í•­:**
1. Supabase í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
2. ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ì •í™•í•œì§€ í™•ì¸ (ë‚ ì§œ í˜•ì‹, tripDays ê³„ì‚° ë“±)
3. Supabase RLS (Row Level Security) ì •ì±… í™•ì¸

**ë””ë²„ê¹…:**
```sql
-- ì •í™•í•œ ì¡°íšŒ í…ŒìŠ¤íŠ¸
SELECT * FROM public.partner_mylinks
WHERE partner_id = 'test-partner'
  AND "from" = 'ICN'
  AND "to" = 'TYO'
  AND departure_date = '2024-11-10'
  AND return_date = '2024-11-13'
  AND trip_days = 3
  AND nonstop = false;
```

### í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë§ˆì´ë§í¬ê°€ ì ìš©ë˜ì§€ ì•ŠìŒ

**í™•ì¸ ì‚¬í•­:**
1. URL ê²½ë¡œê°€ íŒŒíŠ¸ë„ˆ ê²½ë¡œì¸ì§€ í™•ì¸ (`/test-partner`)
2. ê°œë°œì ë„êµ¬ ì½˜ì†”ì—ì„œ ì—ëŸ¬ í™•ì¸
3. Network íƒ­ì—ì„œ API ìš”ì²­ í™•ì¸

**ë””ë²„ê¹…:**
```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸
const testUrl = await fetch('/api/mrt/partner/mylink-query?partnerId=test-partner&from=ICN&to=TYO&depdt=2024-11-10&rtndt=2024-11-13&tripDays=3&nonstop=false');
const data = await testUrl.json();
console.log(data);
```

## ì™„ì „í•œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. âœ… Supabase ìŠ¤í‚¤ë§ˆ ìƒì„±
2. âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì •
3. âœ… ë¡œì»¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë§ˆì´ë§í¬ ìƒì„± (ì†Œê·œëª¨)
4. âœ… Supabaseì—ì„œ ë°ì´í„° í™•ì¸
5. âœ… API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
6. âœ… íŒŒíŠ¸ë„ˆ ê²½ë¡œì—ì„œ ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­
7. âœ… ë§ˆì´ë§í¬ê°€ ì ìš©ë˜ëŠ”ì§€ í™•ì¸
8. âœ… Fallback ë™ì‘ í™•ì¸
9. âœ… ì¼ë°˜ ê²½ë¡œì—ì„œ ê¸°ì¡´ ê¸°ëŠ¥ í™•ì¸

ëª¨ë“  ë‹¨ê³„ê°€ ì„±ê³µí•˜ë©´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ! ğŸ‰




